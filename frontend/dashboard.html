<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor Detection - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-hover:hover { transform: translateY(-4px); transition: all 0.3s ease; }
        .result-tumor { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
        .result-no-tumor { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-800">Brain Tumor AI</span>
                </div>
                
                <div class="flex items-center space-x-6">
                    <button onclick="showView('upload')" class="text-sm font-medium text-gray-700 hover:text-blue-600 transition">
                        üß† New Scan
                    </button>
                    <button onclick="showView('history')" class="text-sm font-medium text-gray-700 hover:text-blue-600 transition">
                        üìã All Scans
                    </button>
                    <span class="text-sm text-gray-600" id="doctorName">Loading...</span>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-700 font-medium">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Scans</p>
                        <p class="text-3xl font-bold text-gray-800 mt-2" id="totalScans">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Tumor Detected</p>
                        <p class="text-3xl font-bold text-red-600 mt-2" id="tumorDetected">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover border border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">No Tumor</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" id="noTumor">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload View -->
        <div id="uploadView" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Upload Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">üß† New Scan</h2>
                    
                    <form id="uploadForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Patient Name</label>
                            <input type="text" id="patientName" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="John Doe">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Patient ID</label>
                            <input type="text" id="patientId" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="P-12345">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Clinical Notes (Optional)</label>
                            <textarea id="notes" rows="3"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Additional observations..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">MRI Image</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer" id="dropZone">
                                <input type="file" id="mriImage" accept="image/*" required class="hidden">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="mt-2 text-sm text-gray-600">Click to upload MRI scan</p>
                                <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                            </div>
                            <div id="imagePreview" class="hidden mt-4">
                                <img id="previewImg" class="w-full rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600 mt-2" id="fileName"></p>
                            </div>
                        </div>

                        <button type="submit" id="analyzeBtn"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition shadow-lg hover:shadow-xl">
                            üî¨ Analyze Scan
                        </button>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-2">
                <!-- Result Card -->
                <div id="resultCard" class="hidden bg-white rounded-xl shadow-lg p-8 mb-6 border-2">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Analysis Complete</h2>
                        <p class="text-gray-600">Scan ID: <span id="scanId" class="font-mono font-semibold"></span></p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üì∏ Original MRI</h3>
                            <img id="originalImage" class="w-full rounded-lg shadow-md border border-gray-200">
                        </div>
                        <div>
                            <h3 class="text-sm font-bold text-gray-700 mb-3">üî• AI Focus Area (Grad-CAM)</h3>
                            <img id="gradcamImage" class="w-full rounded-lg shadow-md border border-gray-200">
                        </div>
                    </div>

                    <div id="predictionBox" class="rounded-xl p-6 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Prediction</p>
                                <p id="predictionText" class="text-3xl font-bold"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-700 mb-1">Confidence</p>
                                <p id="confidenceText" class="text-3xl font-bold"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-gray-800 mb-2">Patient Information</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <p class="text-gray-600">Name: <span id="resultPatientName" class="font-semibold text-gray-800"></span></p>
                            <p class="text-gray-600">ID: <span id="resultPatientId" class="font-semibold text-gray-800"></span></p>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="downloadReport()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition">
                            üìÑ Download PDF Report
                        </button>
                        <button onclick="newScan()" 
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition">
                            ‚ûï New Scan
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingCard" class="hidden bg-white rounded-xl shadow-sm p-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent mb-4"></div>
                    <p class="text-lg font-semibold text-gray-700">Analyzing MRI Scan...</p>
                    <p class="text-sm text-gray-500 mt-2">AI is processing your image</p>
                </div>

                <!-- Recent Scans Preview -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìã Recent Scans</h2>
                        <button onclick="showView('history')" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            View All ‚Üí
                        </button>
                    </div>
                    <div id="recentScans" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">No scans yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History View (All Scans) -->
        <div id="historyView" class="hidden">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">üìã All Scan History</h2>
                    <input type="text" id="searchInput" placeholder="Search patient name or ID..." 
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 w-64"
                        onkeyup="filterScans()">
                </div>
            </div>

            <div id="allScansGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Scans will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4">
            <div class="text-center mb-6">
                <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Scan?</h3>
                <p class="text-gray-600">This action cannot be undone. The scan and all associated files will be permanently deleted.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentScanId = null;
        let deleteScanId = null;
        let allScansData = [];

        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'index.html';
        }

        // View Management
        function showView(view) {
            document.getElementById('uploadView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            
            if (view === 'upload') {
                document.getElementById('uploadView').classList.remove('hidden');
            } else if (view === 'history') {
                document.getElementById('historyView').classList.remove('hidden');
                loadAllScans();
            }
        }

        // Load doctor info
        async function loadDoctorInfo() {
            try {
                const response = await fetch(`${API_URL}/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const doctor = await response.json();
                    document.getElementById('doctorName').textContent = `Dr. ${doctor.full_name}`;
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error loading doctor info:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalScans').textContent = stats.total_scans;
                    document.getElementById('tumorDetected').textContent = stats.tumor_detected;
                    document.getElementById('noTumor').textContent = stats.no_tumor;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load recent scans (for preview)
        async function loadRecentScans() {
            try {
                const response = await fetch(`${API_URL}/scans`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const scans = await response.json();
                    const recentDiv = document.getElementById('recentScans');
                    
                    if (scans.length === 0) {
                        recentDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No scans yet</p>';
                        return;
                    }

                    recentDiv.innerHTML = scans.slice(0, 5).map(scan => createScanCard(scan, true)).join('');
                }
            } catch (error) {
                console.error('Error loading recent scans:', error);
            }
        }

        // Load all scans (for history view)
        async function loadAllScans() {
            try {
                const response = await fetch(`${API_URL}/scans`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    allScansData = await response.json();
                    displayAllScans(allScansData);
                }
            } catch (error) {
                console.error('Error loading all scans:', error);
            }
        }

        // Display all scans in grid
        function displayAllScans(scans) {
            const gridDiv = document.getElementById('allScansGrid');
            
            if (scans.length === 0) {
                gridDiv.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">No scans found</p></div>';
                return;
            }

            gridDiv.innerHTML = scans.map(scan => createFullScanCard(scan)).join('');
        }

        // Create compact scan card (for recent)
        function createScanCard(scan, compact = false) {
            const date = new Date(scan.scan_date).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit'
            });
            const badgeColor = scan.prediction === 'Tumor' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewScanDetail(${scan.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-gray-800">${scan.patient_name}</p>
                            <p class="text-xs text-gray-500">${scan.patient_id}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${badgeColor}">
                            ${scan.prediction}
                        </span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-600">
                        <span>üìÖ ${date}</span>
                        <span>üéØ ${scan.confidence.toFixed(1)}%</span>
                    </div>
                </div>
            `;
        }

        // Create full scan card (for history view)
        function createFullScanCard(scan) {
    const date = new Date(scan.scan_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', 
        hour: '2-digit', minute: '2-digit'
    });

    // Correct label check
    const isTumor = scan.prediction === 'Tumor Detected';
    const badgeColor = isTumor ? 'bg-red-100 text-red-700 border-red-200' : 'bg-green-100 text-green-700 border-green-200';
    const borderColor = isTumor ? 'border-red-200' : 'border-green-200';

    return `
        <div class="bg-white rounded-xl shadow-sm border-2 ${borderColor} overflow-hidden hover:shadow-lg transition">
            <div class="relative">
                <img src="${API_URL}${scan.image_url}" class="w-full h-48 object-cover cursor-pointer" onclick="viewScanDetail(${scan.id})">
                <div class="absolute top-2 right-2">
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${badgeColor} border-2 backdrop-blur-sm">
                        ${scan.prediction}
                    </span>
                </div>
            </div>
            <div class="p-4">
                <div class="mb-3">
                    <p class="font-bold text-gray-800 text-lg">${scan.patient_name}</p>
                    <p class="text-sm text-gray-500">ID: ${scan.patient_id}</p>
                </div>
                <div class="flex items-center justify-between text-sm text-gray-600 mb-3 pb-3 border-b">
                    <span>üìÖ ${date}</span>
                    <span class="font-semibold">üéØ ${scan.confidence.toFixed(1)}%</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadScanReport(${scan.id})" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition">
                        üìÑ PDF
                    </button>
                    <button onclick="viewScanDetail(${scan.id})" class="flex-1 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition">
                        üëÅÔ∏è View
                    </button>
                    <button onclick="showDeleteModal(${scan.id})" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        </div>
    `;
}

        // Filter scans
        function filterScans() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allScansData.filter(scan => 
                scan.patient_name.toLowerCase().includes(searchTerm) ||
                scan.patient_id.toLowerCase().includes(searchTerm)
            );
            displayAllScans(filtered);
        }

        // View scan details
        async function viewScanDetail(scanId) {
            try {
                const response = await fetch(`${API_URL}/scan/${scanId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const scan = await response.json();
                    showView('upload');
                    displayResult(scan);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error viewing scan:', error);
            }
        }

        // Delete modal functions
        function showDeleteModal(scanId) {
            deleteScanId = scanId;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteScanId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteScanId) return;

            try {
                const response = await fetch(`${API_URL}/scan/${deleteScanId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    closeDeleteModal();
                    loadStats();
                    loadAllScans();
                    loadRecentScans();
                    alert('‚úÖ Scan deleted successfully!');
                } else {
                    alert('‚ùå Failed to delete scan');
                }
            } catch (error) {
                console.error('Error deleting scan:', error);
                alert('‚ùå Network error');
            }
        }

        // Download report
        async function downloadScanReport(scanId) {
            try {
                const response = await fetch(`${API_URL}/download-report/${scanId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Brain_Tumor_Report_${scanId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                alert('Failed to download report');
                console.error('Error:', error);
            }
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('mriImage');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const fileName = document.getElementById('fileName');

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    fileName.textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                fileInput.files = e.dataTransfer.files;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    fileName.textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('patient_name', document.getElementById('patientName').value);
            formData.append('patient_id', document.getElementById('patientId').value);
            formData.append('notes', document.getElementById('notes').value);

            // Show loading
            document.getElementById('loadingCard').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult(result);
                    loadStats();
                    loadRecentScans();
                } else {
                    alert('Prediction failed. Please try again.');
                }
            } catch (error) {
                alert('Network error. Please check your connection.');
                console.error('Error:', error);
            } finally {
                document.getElementById('loadingCard').classList.add('hidden');
            }
        });

        // Display results
        function displayResult(result) {
        currentScanId = result.scan_id || result.id;
    
         document.getElementById('resultCard').classList.remove('hidden');
         document.getElementById('scanId').textContent = currentScanId;
         document.getElementById('originalImage').src = `${API_URL}${result.image_url}`;
         document.getElementById('gradcamImage').src = `${API_URL}${result.gradcam_url}`;
         document.getElementById('predictionText').textContent = result.prediction;
         document.getElementById('confidenceText').textContent = `${result.confidence.toFixed(1)}%`;
         document.getElementById('resultPatientName').textContent = result.patient_name;
         document.getElementById('resultPatientId').textContent = result.patient_id;
                
         const predictionBox = document.getElementById('predictionBox');
                
         if (result.prediction === 'Tumor Detected') {
             predictionBox.className = 'result-tumor rounded-xl p-6 mb-4 border-2 border-red-300';
             document.getElementById('predictionText').className = 'text-3xl font-bold text-red-700';
             document.getElementById('confidenceText').className = 'text-3xl font-bold text-red-700';
         } else if (result.prediction === 'No Tumor Detected') {
             predictionBox.className = 'result-no-tumor rounded-xl p-6 mb-4 border-2 border-green-300';
             document.getElementById('predictionText').className = 'text-3xl font-bold text-green-700';
             document.getElementById('confidenceText').className = 'text-3xl font-bold text-green-700';
         } else {
             // fallback for unknown labels
             predictionBox.className = 'rounded-xl p-6 mb-4 border-2 bg-gray-100';
         }

            document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Download PDF report
        async function downloadReport() {
            if (!currentScanId) return;
            downloadScanReport(currentScanId);
        }

        // New scan
        function newScan() {
            document.getElementById('uploadForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            currentScanId = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('doctor');
            window.location.href = 'index.html';
        }

        // Initialize
        loadDoctorInfo();
        loadStats();
        loadRecentScans();
        showView('upload');
    </script>
</body>
</html>